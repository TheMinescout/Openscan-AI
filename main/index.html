<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenScan-AI | Perfected Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --primary: #00f2ff;
            --accent: #7000ff;
            --bg: #050505;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.15);
        }

        body {
            background: radial-gradient(circle at center, #0a0a1a 0%, #050505 100%);
            color: white;
            font-family: 'Inter', sans-serif;
            display: flex;
            justify-content: center;
            padding: 20px;
            min-height: 100vh;
        }

        .app-container {
            width: 100%;
            max-width: 1100px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }

        /* Glassmorphism Panels */
        .panel {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        .scanner-box {
            position: relative;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--primary);
        }

        video, canvas#main-canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Scan Line Overlay */
        .scan-line {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 2px;
            background: var(--primary);
            box-shadow: 0 0 15px var(--primary);
            animation: scanMove 3s linear infinite;
            z-index: 5;
            display: none;
        }

        @keyframes scanMove {
            0% { top: 0%; } 100% { top: 100%; }
        }

        /* Controls */
        .toolbar {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        button {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            font-weight: bold;
        }

        button:hover {
            background: var(--primary);
            color: black;
        }

        button.active { background: var(--primary); color: black; }

        .editor-suite {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        input[type="range"] { width: 100%; margin: 10px 0; }

        textarea {
            width: 100%;
            height: 250px;
            background: transparent;
            color: #00f2ff;
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 10px;
            font-family: monospace;
            resize: none;
        }

        .status-bar { font-size: 0.8rem; color: #888; margin-top: 10px; }

        @media (max-width: 900px) {
            .app-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="panel">
        <h2 style="margin-top:0; color:var(--primary)">OpenScan-AI <span style="font-size: 0.8rem; color: #555;">v2.0 Perfected</span></h2>
        
        <div class="scanner-box">
            <div id="scan-line" class="scan-line"></div>
            <video id="video" autoplay playsinline></video>
            <canvas id="main-canvas" style="display:none;"></canvas>
        </div>

        <div class="toolbar">
            <button onclick="snap()">ðŸ“¸ Capture</button>
            <button id="auto-btn" onclick="toggleAuto()">ðŸ¤– Auto-Scan: OFF</button>
            <button onclick="document.getElementById('file-input').click()">ðŸ“‚ Upload</button>
            <input type="file" id="file-input" hidden onchange="handleFile(event)">
            <button onclick="reset()">ðŸ”„ Reset</button>
        </div>

        <div class="editor-suite" id="editor" style="display:none;">
            <h3>Fine-Tune Image</h3>
            <label>Brightness</label>
            <input type="range" id="bright" min="0" max="200" value="100" oninput="applyManualFilters()">
            <label>Contrast</label>
            <input type="range" id="contrast" min="0" max="200" value="100" oninput="applyManualFilters()">
            <button style="width: 100%; margin-top: 10px;" onclick="runOCR()">âœ¨ Run AI Recognition</button>
        </div>
    </div>

    <div class="panel">
        <h3>Extracted Content</h3>
        <textarea id="output" placeholder="AI text will appear here..."></textarea>
        
        <div class="toolbar" style="justify-content: space-between;">
            <button onclick="copyText()">ðŸ“‹ Copy</button>
            <button onclick="exportPDF()">ðŸ“„ Save PDF</button>
        </div>

        <div class="status-bar" id="status">System: Ready</div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('main-canvas');
    const ctx = canvas.getContext('2d');
    const status = document.getElementById('status');
    const output = document.getElementById('output');
    
    let isAuto = false;
    let stream = null;
    let originalImage = null;

    // Start Camera
    async function init() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = stream;
            if (isAuto) requestAnimationFrame(autoDetectionLoop);
        } catch (e) { status.innerText = "Error: Camera Access Denied"; }
    }

    function toggleAuto() {
        isAuto = !isAuto;
        document.getElementById('auto-btn').innerText = `ðŸ¤– Auto-Scan: ${isAuto ? 'ON' : 'OFF'}`;
        document.getElementById('auto-btn').classList.toggle('active');
        if (isAuto) autoDetectionLoop();
    }

    // Auto Detection (Simple motion/clarity check)
    function autoDetectionLoop() {
        if (!isAuto || video.style.display === 'none') return;
        
        // Use a hidden small canvas for analysis
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = 100; tempCanvas.height = 100;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.drawImage(video, 0, 0, 100, 100);
        
        const pixels = tempCtx.getImageData(0,0,100,100).data;
        let brightness = 0;
        for(let i=0; i<pixels.length; i+=4) brightness += (pixels[i]+pixels[i+1]+pixels[i+2])/3;
        brightness /= 10000;

        // If brightness is stable and high (like a document), snap
        if (brightness > 150) { 
            status.innerText = "Auto-Detecting...";
            setTimeout(snap, 1000); 
            return;
        }
        requestAnimationFrame(autoDetectionLoop);
    }

    function snap() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        
        video.style.display = 'none';
        canvas.style.display = 'block';
        document.getElementById('editor').style.display = 'block';
        document.getElementById('scan-line').style.display = 'block';
        
        originalImage = ctx.getImageData(0,0,canvas.width, canvas.height);
        status.innerText = "Image Captured. Adjust filters or run OCR.";
    }

    function applyManualFilters() {
        const b = document.getElementById('bright').value;
        const c = document.getElementById('contrast').value;
        
        ctx.putImageData(originalImage, 0, 0);
        ctx.filter = `brightness(${b}%) contrast(${c}%) grayscale(100%)`;
        ctx.drawImage(canvas, 0, 0);
        ctx.filter = "none";
    }

    async function runOCR() {
        status.innerText = "AI is thinking...";
        output.value = "Recognizing text... please wait.";
        
        try {
            const result = await Tesseract.recognize(canvas, 'eng');
            output.value = result.data.text;
            status.innerText = "Recognition Complete.";
            // Save to LocalStorage
            localStorage.setItem('lastScan', result.data.text);
        } catch (e) {
            status.innerText = "AI Error: Could not parse image.";
        }
    }

    function handleFile(e) {
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                canvas.width = img.width; canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                video.style.display = 'none';
                canvas.style.display = 'block';
                document.getElementById('editor').style.display = 'block';
                originalImage = ctx.getImageData(0,0,canvas.width, canvas.height);
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(e.target.files[0]);
    }

    function reset() {
        video.style.display = 'block';
        canvas.style.display = 'none';
        document.getElementById('editor').style.display = 'none';
        document.getElementById('scan-line').style.display = 'none';
        output.value = "";
        status.innerText = "Ready";
    }

    function copyText() {
        output.select();
        document.execCommand('copy');
        alert("Copied!");
    }

    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text(output.value, 10, 10);
        doc.save("OpenScan_Export.pdf");
    }

    init();
</script>

</body>
</html>
